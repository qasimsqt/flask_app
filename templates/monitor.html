{% extends "base.html" %}

{% block title %}AI Monitor - Mini Shop{% endblock %}

{% block extra_head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    body {
        background: #2c3e50;
        color: #ecf0f1;
    }
    .container {
        background: rgba(44, 62, 80, 0.95);
        color: #ecf0f1;
    }
</style>
{% endblock %}

{% block content %}
<div class="monitor-header">
    <h1>ü§ñ AI Log Monitor</h1>
    <p>Real-time anomaly detection for e-commerce transactions</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number" id="total-logs">0</div>
        <div>Total Logs</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="anomaly-count">0</div>
        <div>Anomalies</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="normal-count">0</div>
        <div>Normal</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="anomaly-rate">0%</div>
        <div>Anomaly Rate</div>
    </div>
</div>

<div style="margin-bottom: 30px;">
    <button id="logs-tab" class="btn btn-primary" onclick="showTab('logs')">üìä Live Logs</button>
    <button id="anomalies-tab" class="btn btn-success" onclick="showTab('anomalies')">üö® Anomaly Analysis</button>
</div>

<div id="logs-container" class="table-container">
    <table class="monitor-table">
        <thead>
            <tr>
                <th>Type</th>
                <th>Status</th>
                <th>Amount</th>
                <th>Anomaly</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody id="log-table">
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                    <div class="loading"></div>
                    <p style="margin-top: 10px;">Loading logs...</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div id="anomalies-container" class="table-container" style="display: none;">
    <table class="monitor-table">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Isolation Forest</th>
                <th>SVM</th>
                <th>Final Decision</th>
                <th>Confidence</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody id="anomaly-table">
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px;">
                    <div class="loading"></div>
                    <p style="margin-top: 10px;">Loading anomaly analysis...</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div style="text-align: center; margin-top: 20px;">
    <button id="pause-btn" class="btn btn-primary">‚è∏Ô∏è Pause Updates</button>
    <button id="clear-btn" class="btn btn-danger">üóëÔ∏è Clear Display</button>
</div>
{% endblock %}

{% block scripts %}
<script>
let updateInterval;
let isPaused = false;
let currentTab = 'logs';

function showTab(tab) {
    currentTab = tab;
    
    if (tab === 'logs') {
        $('#logs-container').show();
        $('#anomalies-container').hide();
        $('#logs-tab').removeClass('btn-success').addClass('btn-primary');
        $('#anomalies-tab').removeClass('btn-primary').addClass('btn-success');
    } else {
        $('#logs-container').hide();
        $('#anomalies-container').show();
        $('#logs-tab').removeClass('btn-primary').addClass('btn-success');
        $('#anomalies-tab').removeClass('btn-success').addClass('btn-primary');
    }
}

function updateLogs() {
    if (isPaused) return;
    
    $.getJSON("/logs", function(data) {
        $("#log-table").empty();
        
        if (data.length === 0) {
            $("#log-table").append(`
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px;">
                        No logs available yet. Start the log generator to see data.
                    </td>
                </tr>
            `);
            return;
        }
        
        data.reverse().forEach(log => {
            let rowClass = "";
            let anomalyBadge = "";
            
            if (log.anomaly === "Normal") {
                rowClass = "anomaly-normal";
                anomalyBadge = "‚úÖ Normal";
            } else if (log.anomaly === "Training") {
                rowClass = "anomaly-warning";
                anomalyBadge = "üîÑ Training";
            } else if (log.anomaly === "Anomaly") {
                rowClass = "anomaly-danger pulse";
                anomalyBadge = "üö® Anomaly";
            } else {
                anomalyBadge = "‚ùì " + log.anomaly;
            }

            const amount = log.amount ? '$' + log.amount : '$0';
            const details = log.extra || log.path || '-';

            $("#log-table").append(`
                <tr class="${rowClass}">
                    <td>${log.type}</td>
                    <td>${log.status}</td>
                    <td>${amount}</td>
                    <td>${anomalyBadge}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${details}">
                        ${details}
                    </td>
                </tr>
            `);
        });
    }).fail(function() {
        $("#log-table").html(`
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: #e74c3c;">
                    ‚ùå Failed to load logs. Make sure the AI monitor is running.
                </td>
            </tr>
        `);
    });
}

function updateAnomalies() {
    if (isPaused || currentTab !== 'anomalies') return;
    
    $.getJSON("http://localhost:9000/anomalies", function(data) {
        $("#anomaly-table").empty();
        
        if (data.length === 0) {
            $("#anomaly-table").append(`
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px;">
                        No anomaly analysis available yet. Models are training...
                    </td>
                </tr>
            `);
            return;
        }
        
        data.reverse().forEach(result => {
            let rowClass = "";
            let finalDecisionBadge = "";
            let confidenceBadge = "";
            
            if (result.final_decision === "Normal") {
                rowClass = "anomaly-normal";
                finalDecisionBadge = "‚úÖ Normal";
            } else {
                rowClass = "anomaly-danger";
                finalDecisionBadge = "üö® Anomaly";
            }
            
            if (result.confidence === "High") {
                confidenceBadge = "üî¥ High";
            } else if (result.confidence === "Medium") {
                confidenceBadge = "üü° Medium";
            } else {
                confidenceBadge = "üü¢ Low";
            }
            
            const timestamp = new Date(result.timestamp).toLocaleTimeString();
            const amount = result.amount ? '$' + result.amount : '$0';
            const details = result.extra || '-';
            
            const isolationBadge = result.isolation_forest === "Normal" ? "‚úÖ Normal" : "üö® Anomaly";
            const svmBadge = result.svm === "Normal" ? "‚úÖ Normal" : "üö® Anomaly";

            $("#anomaly-table").append(`
                <tr class="${rowClass}">
                    <td>${timestamp}</td>
                    <td>${result.type}</td>
                    <td>${amount}</td>
                    <td>${isolationBadge}</td>
                    <td>${svmBadge}</td>
                    <td>${finalDecisionBadge}</td>
                    <td>${confidenceBadge}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${details}">
                        ${details}
                    </td>
                </tr>
            `);
        });
    }).fail(function() {
        $("#anomaly-table").html(`
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: #e74c3c;">
                    ‚ùå Failed to load anomaly analysis. Make sure the AI monitor is running.
                </td>
            </tr>
        `);
    });
}

function updateStats() {
    if (isPaused) return;
    
    $.getJSON("http://localhost:9000/stats", function(data) {
        $("#total-logs").text(data.total || 0);
        $("#anomaly-count").text(data.anomalies || 0);
        $("#normal-count").text(data.normal || 0);
        $("#anomaly-rate").text((data.anomaly_rate || 0) + '%');
    }).fail(function() {
        // Silently fail for stats
    });
}

$("#pause-btn").click(function() {
    isPaused = !isPaused;
    if (isPaused) {
        $(this).html("‚ñ∂Ô∏è Resume Updates");
        $(this).removeClass("btn-primary").addClass("btn-success");
    } else {
        $(this).html("‚è∏Ô∏è Pause Updates");
        $(this).removeClass("btn-success").addClass("btn-primary");
    }
});

$("#clear-btn").click(function() {
    $("#log-table").html(`
        <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">
                Display cleared. Updates will continue...
            </td>
        </tr>
    `);
});

// Start updates
updateLogs();
updateAnomalies();
updateStats();
setInterval(updateLogs, 2000);
setInterval(updateAnomalies, 3000);
setInterval(updateStats, 5000);
</script>
{% endblock %}